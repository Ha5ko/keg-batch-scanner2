workflows:
  android-apk-build:
    name: Android APK Build (Release)
    max_build_duration: 45
    instance_type: mac_mini_m1
    environment:
      vars:
        PACKAGE_NAME: "com.kegbatchscanner"
      node: 16
      xcode: latest
    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Setup fresh React Native project structure
        script: |
          echo "ðŸš€ Creating fresh React Native project structure..."
          
          # Remove any existing android directory
          rm -rf android ios
          
          # Create fresh RN project to get clean android structure
          npx react-native@0.72.10 init TempProject --version 0.72.10
          
          # Copy the clean android structure
          cp -R TempProject/android .
          
          # Clean up
          rm -rf TempProject
          
          echo "âœ… Fresh Android project structure created"
          
      - name: Install dependencies
        script: |
          echo "ðŸ“¦ Installing npm dependencies..."
          npm install --legacy-peer-deps
          
      - name: Configure Android build
        script: |
          echo "ðŸ”§ Configuring Android build..."
          
          # Set Android SDK path
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          
          # Ensure manifest directory exists
          mkdir -p android/app/src/main
          
          # Copy custom manifest if it exists  
          if [ -f "AndroidManifest-minimal.xml" ]; then
            cp AndroidManifest-minimal.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Minimal AndroidManifest.xml copied"
          elif [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… AndroidManifest.xml copied"
          else
            echo "âš ï¸ Using default AndroidManifest.xml"
          fi
          
          # Configure gradle.properties for optimal build
          cat >> android/gradle.properties << EOF
          
          # Build optimizations
          org.gradle.jvmargs=-Xmx4g
          org.gradle.parallel=true
          org.gradle.daemon=true
          
          # Android settings
          android.useAndroidX=true
          android.enableJetifier=true
          
          # React Native settings
          newArchEnabled=false
          hermesEnabled=true
          EOF
          
          echo "âœ… Android configuration complete"
          
      - name: Build standalone release APK
        script: |
          echo "ðŸ”¨ Building standalone release APK..."
          
          cd android
          
          # Make gradlew executable
          chmod +x ./gradlew
          
          # Clean previous builds
          ./gradlew clean
          
          # Build release APK (unsigned but standalone)
          ./gradlew assembleRelease --no-daemon --stacktrace
          
          # Verify APK was created
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "âœ… Release APK built successfully!"
            ls -la app/build/outputs/apk/release/app-release-unsigned.apk
          elif [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "âœ… Release APK built successfully!"
            ls -la app/build/outputs/apk/release/app-release.apk
          else
            echo "âŒ Release APK build failed - no output file found"
            ls -la app/build/outputs/apk/ || true
            echo "Trying debug APK as fallback..."
            ./gradlew assembleDebug --no-daemon --stacktrace
            if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
              echo "âš ï¸ Debug APK created as fallback"
              ls -la app/build/outputs/apk/debug/app-debug.apk
            fi
            exit 1
          fi
          
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
      
    publishing:
      email:
        recipients:
          - shantu.hasko@ab-inbev.com
        notify:
          success: true
          failure: true
