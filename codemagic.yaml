workflows:
  android-keg-scanner:
    name: Keg Scanner Android Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        PACKAGE_NAME: "com.kegbatchscanner"
      node: 16
      xcode: latest
    triggering:
      events:
        - push
        - tag
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Initialize React Native Project
        script: |
          echo "ðŸš€ Setting up React Native project structure..."
          
          # Check if we already have a React Native project
          if [ ! -d "android" ]; then
            echo "ðŸ“± Creating React Native project..."
            
            # Create a fresh React Native project
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10
            
            # Copy the generated android and ios folders to our project
            if [ -d "KegBatchScannerTemp/android" ]; then
              cp -r KegBatchScannerTemp/android .
              echo "âœ… Android project structure copied"
            fi
            
            if [ -d "KegBatchScannerTemp/ios" ]; then
              cp -r KegBatchScannerTemp/ios .
              echo "âœ… iOS project structure copied"
            fi
            
            # Clean up temporary project
            rm -rf KegBatchScannerTemp
          else
            echo "âœ… Android directory already exists"
          fi
      - name: Install npm dependencies
        script: |
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps
      - name: Set up Android environment
        script: |
          echo "ðŸ”§ Setting up Android environment..."
          
          # Ensure android directory exists
          if [ ! -d "android" ]; then
            echo "âŒ Android directory missing after setup!"
            exit 1
          fi
          
          # Set up local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          echo "âœ… Android SDK path configured: $ANDROID_SDK_ROOT"
      - name: Copy Android Manifest and configure permissions
        script: |
          echo "ðŸ“„ Setting up Android manifest and permissions..."
          
          # Ensure the manifest directory exists
          mkdir -p android/app/src/main
          
          # Copy our custom manifest with camera permissions
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Custom Android manifest with camera permissions copied"
          else
            echo "âš ï¸ AndroidManifest.xml not found, using default"
          fi
          
          # Verify manifest exists
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "âœ… AndroidManifest.xml is in place"
            # Show relevant permissions
            grep -n "CAMERA\|camera" android/app/src/main/AndroidManifest.xml || echo "âš ï¸ Camera permissions not found in manifest"
          else
            echo "âŒ AndroidManifest.xml missing!"
          fi
      - name: Set up Gradle properties
        script: |
          echo "âš™ï¸ Configuring Gradle properties..."
          
          # Add optimized gradle properties
          cat >> android/gradle.properties << EOF
          
          # React Native optimizations
          org.gradle.jvmargs=-Xmx4096m -XX:MaxPermSize=512m -XX:+UseParallelGC
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=true
          
          # Android build optimizations
          android.useAndroidX=true
          android.enableJetifier=true
          android.enableR8=true
          
          # Vision Camera
          disableNewArchitecture=false
          
          # Flipper
          FLIPPER_VERSION=0.125.0
          EOF
          echo "âœ… Gradle properties configured"
      - name: Clean and build Android APK
        script: |
          echo "ðŸ”¨ Building Android APK..."
          cd android
          
          # Show available gradle tasks
          echo "ðŸ“‹ Available Gradle tasks:"
          ./gradlew tasks --all | grep assemble | head -10
          
          # Clean previous builds
          echo "ðŸ§¹ Cleaning previous builds..."
          ./gradlew clean
          
          # Build debug APK first (most likely to succeed)
          echo "ðŸ”¨ Building debug APK..."
          ./gradlew assembleDebug --stacktrace --info
          
          # Try release APK (may fail without keystore, but that's OK)
          echo "ðŸ”¨ Attempting release APK..."
          ./gradlew assembleRelease --stacktrace || echo "âš ï¸ Release build failed (expected without keystore)"
      - name: Verify and list APKs
        script: |
          echo "ðŸ“± Checking for generated APK files..."
          
          # Search for all APK files
          echo "=== All APK files found ==="
          find . -name "*.apk" -type f -exec ls -lh {} \; 2>/dev/null || echo "No APK files found"
          
          # Check specific common locations
          APK_LOCATIONS=(
            "android/app/build/outputs/apk/debug/app-debug.apk"
            "android/app/build/outputs/apk/release/app-release.apk"
            "android/app/build/outputs/apk/release/app-release-unsigned.apk"
          )
          
          FOUND_APKS=0
          for apk in "${APK_LOCATIONS[@]}"; do
            if [ -f "$apk" ]; then
              echo "âœ… Found: $apk"
              ls -lh "$apk"
              FOUND_APKS=$((FOUND_APKS + 1))
            fi
          done
          
          if [ $FOUND_APKS -gt 0 ]; then
            echo "ðŸŽ‰ Success! Found $FOUND_APKS APK file(s)"
          else
            echo "âŒ No APK files generated!"
            echo "Checking build outputs directory:"
            ls -la android/app/build/ 2>/dev/null || echo "Build directory not found"
            exit 1
          fi
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/**/mapping.txt
      - android/app/build/reports/**
    publishing:
      email:
        recipients:
          - shantu.hasko@ab-inbev.com
        notify:
          success: true
          failure: true
