workflows:
  android-apk:
    name: Android APK (Fresh RN Android each build)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate fresh Android project
        script: |
          set -e
          echo "ðŸ§¼ Forcing a fresh generated android/ each build..."
          rm -rf android ios KegBatchScannerTemp

          echo "ðŸ“± Creating RN template project (0.72.10)..."
          npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install

          echo "âœ… Copying android/ into workspace..."
          cp -R KegBatchScannerTemp/android .
          rm -rf KegBatchScannerTemp

          echo "âœ… android/ generated"

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + Manifest + gradle.properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build..."

          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

          mkdir -p android/app/src/main
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Copied root AndroidManifest.xml into android/app/src/main/"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          # Write SAFE gradle.properties (NO MaxPermSize)
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          newArchEnabled=false
          hermesEnabled=true
          EOF

          echo "âœ… android/gradle.properties written"

      - name: Show and repair android/app/build.gradle around Hermes/JSC block
        script: |
          set -e
          APP_GRADLE="android/app/build.gradle"
          echo "ðŸ” Showing lines 90â€“140 of android/app/build.gradle (pre-repair):"
          nl -ba "$APP_GRADLE" | sed -n '90,140p' || true

          # If the file contains the common Hermes/JSC block but it's malformed, repair it.
          # This targets the typical spot that triggers the exact parse error you pasted.
          #
          # Replace any broken occurrence of:
          #   { implementation jscFlavor }
          # with the correct else block:
          #   else { implementation jscFlavor }
          #
          # (We only touch the minimal pattern that causes the Groovy parser to choke.)
          perl -0777 -i -pe 's/\n\s*\{\s*\n\s*implementation\s+jscFlavor\s*\n\s*\}\s*\n\s*\}/\n    else {\n        implementation jscFlavor\n    }\n}/gs' "$APP_GRADLE"

          echo "ðŸ” Showing lines 90â€“140 of android/app/build.gradle (post-repair):"
          nl -ba "$APP_GRADLE" | sed -n '90,140p' || true

      - name: Disable Flipper dependencies safely (no brace edits)
        script: |
          set -e
          APP_GRADLE="android/app/build.gradle"
          echo "ðŸ§¯ Removing only Flipper dependency lines (no structural edits)..."

          # Remove only dependency lines that reference com.facebook.flipper
          sed -i '/debugImplementation.*com\.facebook\.flipper:/d' "$APP_GRADLE"
          sed -i '/releaseImplementation.*com\.facebook\.flipper:/d' "$APP_GRADLE"

          echo "âœ… Flipper dependency lines removed (if any)"

      - name: Build Debug APK
        script: |
          set -e
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
