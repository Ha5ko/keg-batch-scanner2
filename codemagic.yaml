workflows:
  android-keg-scanner:
    name: Keg Batch Scanner (Android APK)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate Android project (only if missing)
        script: |
          set -e
          echo "ðŸ”Ž Checking for android/ folder..."
          if [ ! -d "android" ]; then
            echo "ðŸ“± android/ not found. Generating RN template android project..."
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install
            cp -R KegBatchScannerTemp/android .
            rm -rf KegBatchScannerTemp
            echo "âœ… android/ generated"
          else
            echo "âœ… android/ already exists"
          fi

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + Manifest + Gradle properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build..."

          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          mkdir -p android/app/src/main

          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Copied AndroidManifest.xml into android/app/src/main/"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          # SAFE gradle.properties (NO MaxPermSize)
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          newArchEnabled=false
          hermesEnabled=true
          EOF

          echo "âœ… android/gradle.properties written"

      - name: Disable Flipper (surgical, CI-safe)
        script: |
          set -e
          echo "ðŸ§¯ Disabling Flipper (dependency lines only)..."

          APP_GRADLE="android/app/build.gradle"
          if [ ! -f "$APP_GRADLE" ]; then
            echo "âŒ $APP_GRADLE not found"
            exit 1
          fi

          echo "ðŸ” Flipper lines BEFORE:"
          grep -n "com.facebook.flipper" "$APP_GRADLE" || true

          # Remove only the Flipper dependency lines (do NOT delete generic words like 'Flipper' or braces)
          # Covers both styles: debugImplementation("...") and debugImplementation(...)
          sed -i '/debugImplementation.*com\.facebook\.flipper:flipper/d' "$APP_GRADLE"
          sed -i '/debugImplementation.*com\.facebook\.flipper:flipper-network-plugin/d' "$APP_GRADLE"
          sed -i '/debugImplementation.*com\.facebook\.flipper:flipper-fresco-plugin/d' "$APP_GRADLE"
          sed -i '/debugImplementation.*com\.facebook\.flipper:flipper-noop/d' "$APP_GRADLE"

          echo "ðŸ” Flipper lines AFTER:"
          grep -n "com.facebook.flipper" "$APP_GRADLE" || true

          # If the generated template includes ReactNativeFlipper init, remove it safely.
          # (May not exist depending on template version.)
          MAIN_APP_JAVA=$(find android/app/src/main/java -name "MainApplication.java" 2>/dev/null | head -n 1 || true)
          MAIN_APP_KT=$(find android/app/src/main/java -name "MainApplication.kt" 2>/dev/null | head -n 1 || true)

          if [ -n "$MAIN_APP_JAVA" ]; then
            if grep -q "ReactNativeFlipper" "$MAIN_APP_JAVA"; then
              echo "ðŸ§¼ Removing ReactNativeFlipper references in $MAIN_APP_JAVA"
              sed -i '/ReactNativeFlipper/d' "$MAIN_APP_JAVA"
              # remove the common initializeFlipper(...) call line if present
              sed -i '/initializeFlipper/d' "$MAIN_APP_JAVA"
            fi
          fi

          if [ -n "$MAIN_APP_KT" ]; then
            if grep -q "ReactNativeFlipper" "$MAIN_APP_KT"; then
              echo "ðŸ§¼ Removing ReactNativeFlipper references in $MAIN_APP_KT"
              sed -i '/ReactNativeFlipper/d' "$MAIN_APP_KT"
              sed -i '/initializeFlipper/d' "$MAIN_APP_KT"
            fi
          fi

          echo "âœ… Flipper disabled safely"

      - name: Build Debug APK
        script: |
          set -e
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
