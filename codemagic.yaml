workflows:
  android-keg-scanner:
    name: Keg Batch Scanner (Android APK)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate Android project (only if missing)
        script: |
          set -e
          echo "ðŸ”Ž Checking for android/ folder..."
          if [ ! -d "android" ]; then
            echo "ðŸ“± android/ not found. Generating RN template android project..."
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install

            echo "âœ… Copying generated android/ into workspace..."
            cp -R KegBatchScannerTemp/android .

            rm -rf KegBatchScannerTemp
          else
            echo "âœ… android/ already exists"
          fi

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + Manifest + Gradle properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build..."

          # Point Gradle at the Android SDK
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

          # Ensure manifest folder exists
          mkdir -p android/app/src/main

          # Copy your custom manifest into the generated Android project
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Copied AndroidManifest.xml into android/app/src/main/"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          # Write SAFE gradle.properties (NO MaxPermSize) + define FLIPPER_VERSION
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          # React Native
          newArchEnabled=false
          hermesEnabled=true

          # âœ… Fix for Codemagic failure:
          # RN template app/build.gradle references FLIPPER_VERSION
          FLIPPER_VERSION=0.201.0
          EOF

          echo "âœ… android/gradle.properties written:"
          cat android/gradle.properties

      - name: Build Debug APK
        script: |
          set -e
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
