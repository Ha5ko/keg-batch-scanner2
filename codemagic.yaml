workflows:
  android-keg-scanner:
    name: Keg Batch Scanner (Android APK)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate Android project (only if missing)
        script: |
          set -e
          echo "ðŸ”Ž Checking for android/ folder..."
          if [ ! -d "android" ]; then
            echo "ðŸ“± android/ not found. Generating RN template android project..."
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install
            cp -R KegBatchScannerTemp/android .
            rm -rf KegBatchScannerTemp
            echo "âœ… android/ generated"
          else
            echo "âœ… android/ already exists"
          fi

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + Manifest + Gradle properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build..."

          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          mkdir -p android/app/src/main

          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Copied AndroidManifest.xml into android/app/src/main/"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          # SAFE gradle.properties (NO MaxPermSize)
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          newArchEnabled=false
          hermesEnabled=true
          EOF

          echo "âœ… android/gradle.properties written"

      - name: Disable Flipper in generated Android project (CI-safe)
        script: |
          set -e
          echo "ðŸ§¯ Disabling Flipper to avoid dependency resolution issues..."

          APP_GRADLE="android/app/build.gradle"
          if [ ! -f "$APP_GRADLE" ]; then
            echo "âŒ $APP_GRADLE not found"
            exit 1
          fi

          echo "ðŸ” Before patch, Flipper lines:"
          grep -n "flipper" -i "$APP_GRADLE" || true

          # Remove any flipper dependencies (fresco/network/soloader/etc)
          # This is safe even if the lines don't exist.
          sed -i '/com\.facebook\.flipper/d' "$APP_GRADLE"
          sed -i '/flipper-/Id' "$APP_GRADLE"
          sed -i '/SoLoader/Id' "$APP_GRADLE"
          sed -i '/Flipper/Id' "$APP_GRADLE"

          echo "âœ… Patched android/app/build.gradle"
          echo "ðŸ” After patch, Flipper lines:"
          grep -n "flipper" -i "$APP_GRADLE" || true

          # Also patch MainApplication if the template enables Flipper initialization
          # Handles both Java and Kotlin templates.
          MAIN_APP_JAVA=$(find android/app/src/main/java -name "MainApplication.java" 2>/dev/null | head -n 1 || true)
          MAIN_APP_KT=$(find android/app/src/main/java -name "MainApplication.kt" 2>/dev/null | head -n 1 || true)

          if [ -n "$MAIN_APP_JAVA" ]; then
            echo "ðŸ§¼ Patching Flipper init in $MAIN_APP_JAVA"
            # Remove ReactNativeFlipper import + init call blocks if present
            sed -i '/ReactNativeFlipper/d' "$MAIN_APP_JAVA"
            # Remove block that calls ReactNativeFlipper.initializeFlipper(...)
            perl -0777 -i -pe 's/\n\s*if\s*\(BuildConfig\.DEBUG\)\s*\{\s*\n\s*ReactNativeFlipper\.initializeFlipper\([\s\S]*?\);\s*\n\s*\}\s*\n/\n/gs' "$MAIN_APP_JAVA"
          fi

          if [ -n "$MAIN_APP_KT" ]; then
            echo "ðŸ§¼ Patching Flipper init in $MAIN_APP_KT"
            sed -i '/ReactNativeFlipper/d' "$MAIN_APP_KT"
            perl -0777 -i -pe 's/\n\s*if\s*\(BuildConfig\.DEBUG\)\s*\{\s*\n\s*ReactNativeFlipper\.initializeFlipper\([\s\S]*?\)\s*\n\s*\}\s*\n/\n/gs' "$MAIN_APP_KT"
          fi

          echo "âœ… Flipper disabled"

      - name: Build Debug APK
        script: |
          set -e
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
