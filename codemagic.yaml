workflows:
  android-keg-scanner:
    name: Keg Scanner Android Build (APK)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      vars:
        PACKAGE_NAME: "com.kegbatchscanner"
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate Android project (only if missing)
        script: |
          set -e
          echo "ðŸš€ Checking Android folder..."
          if [ ! -d "android" ]; then
            echo "ðŸ“± android/ not found, generating RN template..."
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install

            echo "âœ… Copying generated android/ into repo workspace..."
            cp -R KegBatchScannerTemp/android .

            # Optional: if you ever want iOS later, uncomment:
            # cp -R KegBatchScannerTemp/ios .

            rm -rf KegBatchScannerTemp
          else
            echo "âœ… android/ already exists"
          fi

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing npm dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + manifest + gradle.properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build environment..."

          # Ensure local.properties points to the Android SDK
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          echo "âœ… android/local.properties set to $ANDROID_SDK_ROOT"

          # Ensure manifest folder exists
          mkdir -p android/app/src/main

          # Copy custom manifest (from repo root) into Android project
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Custom AndroidManifest.xml copied"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          # Write SAFE gradle.properties (overwrite / ensure our settings exist)
          # Important: NO MaxPermSize (breaks modern Java)
          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          # React Native New Architecture (keep OFF for reliability)
          newArchEnabled=false

          # Hermes
          hermesEnabled=true
          EOF

          echo "âœ… android/gradle.properties written"
          echo "ðŸ“‹ android/gradle.properties:"
          cat android/gradle.properties

      - name: Build Debug APK (primary)
        script: |
          set -e
          echo "ðŸ”¨ Building Debug APK..."
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Attempt Release APK (optional)
        script: |
          set +e
          echo "ðŸ”¨ Attempting Release APK..."
          cd android
          ./gradlew assembleRelease --no-daemon --stacktrace
          exit 0

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
      - android/app/build/outputs/**/mapping.txt

    publishing:
      email:
        recipients:
          - shantu.hasko@ab-inbev.com
        notify:
          success: true
          failure: true
