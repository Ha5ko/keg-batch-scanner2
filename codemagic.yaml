workflows:
  android-keg-scanner:
    name: Keg Scanner Android Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        PACKAGE_NAME: "com.kegbatchscanner"
      node: 16
      xcode: latest
    triggering:
      events:
        - push
        - tag
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Initialize React Native Project
        script: |
          echo "ðŸš€ Setting up React Native project structure..."
          
          # Check if we already have a React Native project
          if [ ! -d "android" ]; then
            echo "ðŸ“± Creating React Native project..."
            
            # Create a fresh React Native project
            npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10
            
            # Copy the generated android and ios folders to our project
            if [ -d "KegBatchScannerTemp/android" ]; then
              cp -r KegBatchScannerTemp/android .
              echo "âœ… Android project structure copied"
            fi
            
            if [ -d "KegBatchScannerTemp/ios" ]; then
              cp -r KegBatchScannerTemp/ios .
              echo "âœ… iOS project structure copied"
            fi
            
            # Clean up temporary project
            rm -rf KegBatchScannerTemp
          else
            echo "âœ… Android directory already exists"
          fi
      - name: Install npm dependencies
        script: |
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps
      - name: Set up Android environment
        script: |
          echo "ðŸ”§ Setting up Android environment..."
          
          # Ensure android directory exists
          if [ ! -d "android" ]; then
            echo "âŒ Android directory missing after setup!"
            exit 1
          fi
          
          # Set up local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
          echo "âœ… Android SDK path configured: $ANDROID_SDK_ROOT"
          
          # Verify Android SDK is accessible
          if [ -d "$ANDROID_SDK_ROOT" ]; then
            echo "âœ… Android SDK found at: $ANDROID_SDK_ROOT"
            ls -la "$ANDROID_SDK_ROOT" | head -5
          else
            echo "âš ï¸ Android SDK directory not found!"
          fi
      - name: Copy Android Manifest and configure permissions
        script: |
          echo "ðŸ“„ Setting up Android manifest and permissions..."
          
          # Ensure the manifest directory exists
          mkdir -p android/app/src/main
          
          # Copy our custom manifest with camera permissions
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Custom Android manifest with camera permissions copied"
          else
            echo "âš ï¸ AndroidManifest.xml not found, using default"
          fi
          
          # Verify manifest exists
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "âœ… AndroidManifest.xml is in place"
            # Show relevant permissions
            grep -n "CAMERA\|camera" android/app/src/main/AndroidManifest.xml || echo "âš ï¸ Camera permissions not found in manifest"
          else
            echo "âŒ AndroidManifest.xml missing!"
          fi
      - name: Set up Gradle properties
        script: |
          echo "âš™ï¸ Configuring Gradle properties..."
          
          # Add optimized gradle properties
          cat >> android/gradle.properties << EOF
          
          # React Native optimizations
          org.gradle.jvmargs=-Xmx4096m -XX:MaxPermSize=512m -XX:+UseParallelGC
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=true
          
          # Android build optimizations
          android.useAndroidX=true
          android.enableJetifier=true
          android.enableR8=true
          
          # Vision Camera
          disableNewArchitecture=false
          
          # Flipper
          FLIPPER_VERSION=0.125.0
          EOF
          echo "âœ… Gradle properties configured"
          
          echo "ðŸ“‹ Final gradle.properties content:"
          cat android/gradle.properties
      - name: Pre-build verification
        script: |
          echo "ðŸ” Pre-build verification..."
          
          # Check key files exist
          echo "=== Key files check ==="
          [ -f "package.json" ] && echo "âœ… package.json" || echo "âŒ package.json missing"
          [ -f "App.js" ] && echo "âœ… App.js" || echo "âŒ App.js missing"
          [ -f "android/build.gradle" ] && echo "âœ… android/build.gradle" || echo "âŒ android/build.gradle missing"
          [ -f "android/app/build.gradle" ] && echo "âœ… android/app/build.gradle" || echo "âŒ android/app/build.gradle missing"
          [ -f "android/local.properties" ] && echo "âœ… android/local.properties" || echo "âŒ android/local.properties missing"
          
          # Show gradle wrapper version
          echo "=== Gradle wrapper version ==="
          cd android && ./gradlew --version | head -10
      - name: Clean and build Android APK
        script: |
          echo "ðŸ”¨ Building Android APK with detailed logging..."
          cd android
          
          # Show available gradle tasks for debugging
          echo "ðŸ“‹ Available assemble tasks:"
          ./gradlew tasks | grep -i assemble
          
          # Clean previous builds
          echo "ðŸ§¹ Cleaning previous builds..."
          ./gradlew clean --stacktrace
          
          # Build debug APK with maximum verbosity
          echo "ðŸ”¨ Building debug APK with full logging..."
          ./gradlew assembleDebug --stacktrace --info --debug > ../build-debug.log 2>&1 || {
            echo "âŒ Debug build failed. Last 50 lines of log:"
            tail -50 ../build-debug.log
            echo "âŒ Debug build failed, but continuing..."
          }
          
          # Check if debug APK was created
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "âœ… Debug APK created successfully!"
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "âŒ Debug APK not created"
            echo "Checking debug outputs directory:"
            ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "Debug output directory doesn't exist"
          fi
          
          # Try release build (might fail without keystore)
          echo "ðŸ”¨ Attempting release APK..."
          ./gradlew assembleRelease --stacktrace > ../build-release.log 2>&1 || {
            echo "âš ï¸ Release build failed (expected without keystore)"
            echo "Last 20 lines of release build log:"
            tail -20 ../build-release.log
          }
          
          # Check if release APK was created
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ] || [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "âœ… Release APK created!"
            ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null
          fi
      - name: Debug build outputs
        script: |
          echo "ðŸ” Detailed build outputs investigation..."
          
          # Show complete outputs directory structure
          echo "=== Complete outputs directory structure ==="
          find android/app/build/outputs -type f 2>/dev/null | head -20 || echo "No files found in outputs"
          
          # Show all directories under build
          echo "=== Build directory structure ==="
          find android/app/build -type d -name "*apk*" 2>/dev/null || echo "No APK directories found"
          
          # Look for any generated files
          echo "=== Any .apk files anywhere ==="
          find android -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
          
          # Check build logs for errors
          echo "=== Build error patterns ==="
          grep -i "error\|failed\|exception" ../build-debug.log | tail -10 || echo "No obvious errors in debug log"
          
          # Show gradle build cache info
          echo "=== Gradle build info ==="
          cd android && ./gradlew --status || echo "Could not get gradle status"
      - name: Verify and list APKs
        script: |
          echo "ðŸ“± Final APK verification..."
          
          # Search for all APK files recursively
          echo "=== All APK files found ==="
          find . -name "*.apk" -type f -exec ls -lh {} \; 2>/dev/null || echo "No APK files found anywhere"
          
          # Check specific common locations
          APK_LOCATIONS=(
            "android/app/build/outputs/apk/debug/app-debug.apk"
            "android/app/build/outputs/apk/release/app-release.apk"
            "android/app/build/outputs/apk/release/app-release-unsigned.apk"
          )
          
          FOUND_APKS=0
          for apk in "${APK_LOCATIONS[@]}"; do
            if [ -f "$apk" ]; then
              echo "âœ… Found: $apk"
              ls -lh "$apk"
              FOUND_APKS=$((FOUND_APKS + 1))
            else
              echo "âŒ Missing: $apk"
            fi
          done
          
          if [ $FOUND_APKS -gt 0 ]; then
            echo "ðŸŽ‰ Success! Found $FOUND_APKS APK file(s)"
            exit 0
          else
            echo "âŒ No APK files generated!"
            echo "=== Final diagnosis ==="
            echo "Build directory contents:"
            ls -la android/app/build/ 2>/dev/null || echo "Build directory not found"
            echo "=== This indicates a build failure. Check logs above. ==="
            # Don't exit 1 here so we can still get artifacts
            echo "Continuing to generate artifacts for debugging..."
          fi
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/**/mapping.txt
      - android/app/build/reports/**
      - build-debug.log
      - build-release.log
    publishing:
      email:
        recipients:
          - shantu.hasko@ab-inbev.com
        notify:
          success: true
          failure: true
