workflows:
  android-apk:
    name: Android APK (Repair Gradle + Build)
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      node: 18
      java: 11

    triggering:
      events:
        - push
        - pull_request
        - tag
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Generate fresh Android project
        script: |
          set -e
          echo "ðŸ§¼ Forcing fresh android/ each build..."
          rm -rf android ios KegBatchScannerTemp

          echo "ðŸ“± Creating RN template project (0.72.10)..."
          npx react-native@0.72.10 init KegBatchScannerTemp --version 0.72.10 --skip-install

          cp -R KegBatchScannerTemp/android .
          rm -rf KegBatchScannerTemp
          echo "âœ… android/ generated"

      - name: Install JS dependencies
        script: |
          set -e
          echo "ðŸ“¦ Installing dependencies..."
          npm install --legacy-peer-deps

      - name: Configure Android SDK + Manifest + gradle.properties
        script: |
          set -e
          echo "ðŸ”§ Configuring Android build..."
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

          mkdir -p android/app/src/main
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Copied AndroidManifest.xml into android/app/src/main/"
          else
            echo "âŒ AndroidManifest.xml not found at repo root"
            exit 1
          fi

          cat > android/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g
          org.gradle.parallel=true
          org.gradle.daemon=true
          org.gradle.configureondemand=true

          android.useAndroidX=true
          android.enableJetifier=true

          newArchEnabled=false
          hermesEnabled=true
          EOF

          echo "âœ… android/gradle.properties written"

      - name: Repair Hermes/JSC block in android/app/build.gradle
        script: |
          set -e
          APP_GRADLE="android/app/build.gradle"

          echo "ðŸ” Showing lines 95â€“135 BEFORE repair:"
          nl -ba "$APP_GRADLE" | sed -n '95,135p' || true

          # 1) Remove ANY existing broken hermes/jsc conditional block variants
          #    We delete from the start of the hermesEnabled if-block up to the next closing brace that ends it.
          #    Then we insert a known-good block.
          #
          # Known-good snippet:
          # if (hermesEnabled.toBoolean()) {
          #     implementation("com.facebook.react:hermes-android")
          # } else {
          #     implementation jscFlavor
          # }
          #
          perl -0777 -i -pe '
            # Delete any existing hermesEnabled conditional (even if malformed)
            s/\n\s*if\s*\(\s*hermesEnabled\.toBoolean\(\)\s*\)\s*\{[\s\S]*?\n\s*\}\s*//g;

            # Also delete the common malformed standalone jscFlavor block: "{ implementation jscFlavor }"
            s/\n\s*\{\s*\n\s*implementation\s+jscFlavor\s*\n\s*\}\s*//g;
          ' "$APP_GRADLE"

          # 2) Insert the known-good conditional right after the line defining jscFlavor
          #    (This keeps it inside dependencies {} where templates expect it.)
          perl -i -pe '
            if (!$done && $_ =~ /def\s+jscFlavor\s*=/) {
              $done=1;
              $_ .= "\n// âœ… CI Repair: ensure Hermes/JSC dependency block is valid Groovy\n";
              $_ .= "if (hermesEnabled.toBoolean()) {\n";
              $_ .= "    implementation(\"com.facebook.react:hermes-android\")\n";
              $_ .= "} else {\n";
              $_ .= "    implementation jscFlavor\n";
              $_ .= "}\n";
            }
          ' "$APP_GRADLE"

          echo "ðŸ” Showing lines 95â€“135 AFTER repair:"
          nl -ba "$APP_GRADLE" | sed -n '95,135p' || true

      - name: Disable Flipper dependencies safely
        script: |
          set -e
          APP_GRADLE="android/app/build.gradle"
          echo "ðŸ§¯ Removing Flipper dependency lines only..."
          sed -i '/debugImplementation.*com\.facebook\.flipper:/d' "$APP_GRADLE"
          sed -i '/releaseImplementation.*com\.facebook\.flipper:/d' "$APP_GRADLE"
          echo "âœ… Flipper lines removed (if present)"

      - name: Build Debug APK
        script: |
          set -e
          cd android
          chmod +x ./gradlew
          ./gradlew --version
          ./gradlew clean
          ./gradlew assembleDebug --no-daemon --stacktrace

    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/reports/**
