workflows:
  android-keg-scanner:
    name: Keg Scanner Android Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        PACKAGE_NAME: "com.kegbatchscanner"
      node: 16
      xcode: latest
    triggering:
      events:
        - push
        - tag
        - pull_request
      branch_patterns:
        - pattern: main
          include: true
          source: true
    scripts:
      - name: Install npm dependencies
        script: |
          npm install --legacy-peer-deps
      - name: Set up Android environment
        script: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties
      - name: Copy Android Manifest
        script: |
          # Copy the updated manifest with camera permissions
          if [ -f "AndroidManifest.xml" ]; then
            cp AndroidManifest.xml android/app/src/main/AndroidManifest.xml
            echo "âœ… Android manifest updated with camera permissions"
          fi
      - name: Set up Gradle properties
        script: |
          # Create gradle.properties with proper settings
          cat >> android/gradle.properties << EOF
          # React Native optimizations
          org.gradle.jvmargs=-Xmx4096m -XX:MaxPermSize=512m -XX:+UseParallelGC
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          org.gradle.daemon=true
          
          # Android build optimizations
          android.useAndroidX=true
          android.enableJetifier=true
          android.enableR8=true
          
          # Vision Camera
          disableNewArchitecture=false
          
          # Flipper
          FLIPPER_VERSION=0.125.0
          EOF
          echo "âœ… Gradle properties configured"
      - name: Clean and build Android APK
        script: |
          cd android
          
          # Clean previous builds
          echo "ðŸ§¹ Cleaning previous builds..."
          ./gradlew clean
          
          # Build the debug APK (unsigned - works without keystore)
          echo "ðŸ”¨ Building debug APK..."
          ./gradlew assembleDebug --stacktrace
          
          # Also try release APK (unsigned)
          echo "ðŸ”¨ Building release APK..."
          ./gradlew assembleRelease --stacktrace || echo "Release build failed, debug APK available"
      - name: Verify APK was created
        script: |
          echo "=== Searching for APK files ==="
          find android/app/build/outputs -name "*.apk" -exec ls -lh {} \;
          
          # Check for debug APK
          DEBUG_APK="android/app/build/outputs/apk/debug/app-debug.apk"
          RELEASE_APK="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          RELEASE_APK2="android/app/build/outputs/apk/release/app-release.apk"
          
          if [ -f "$DEBUG_APK" ]; then
            echo "âœ… Debug APK built successfully!"
            ls -lh "$DEBUG_APK"
          fi
          
          if [ -f "$RELEASE_APK" ] || [ -f "$RELEASE_APK2" ]; then
            echo "âœ… Release APK built successfully!"
            ls -lh android/app/build/outputs/apk/release/*.apk
          fi
          
          # Count total APKs
          APK_COUNT=$(find android/app/build/outputs -name "*.apk" | wc -l)
          if [ "$APK_COUNT" -gt 0 ]; then
            echo "âœ… Build successful! Found $APK_COUNT APK(s)"
          else
            echo "âŒ No APKs found!"
            exit 1
          fi
    artifacts:
      - android/app/build/outputs/**/*.apk
      - android/app/build/outputs/**/mapping.txt
    publishing:
      email:
        recipients:
          - shantu.hasko@ab-inbev.com
        notify:
          success: true
          failure: true
